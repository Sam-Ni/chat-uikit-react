"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),s=require("react"),t=require("react/jsx-runtime"),a=require("../../context/TUIKitContext.js"),r=require("../../context/TUIChatStateContext.js"),n=require("../../context/TUIChatActionContext.js"),i=require("../../context/ComponentContext.js"),o=require("./hooks/useCreateTUIChatStateContext.js"),u=require("../TUIMessage/TUIMessage.js");require("../TUIMessage/MessagePlugins.js"),require("../TUIMessage/MessageContext.js");var g=require("../../constants.js"),c=require("./hooks/useMessageReceviedListener.js"),T=require("./TUIChatState.js"),M=require("./hooks/useCreateMessage.js"),d=require("./hooks/useHandleMessageList.js"),I=require("./hooks/useHandleMessage.js"),l=require("../TUIChatHeader/TUIChatHeader.js");require("../TUIChatHeader/TUIChatHeaderDefault.js");var C=require("../TUIMessageList/TUIMessageList.js"),_=require("../TUIMessageInput/TUIMessageInput.js");require("../../context/TUIMessageContext.js"),require("../../context/TUIMessageInputContext.js"),require("../Icon/config.js"),require("../Icon/type.js"),require("../Plugins/index.js");var v=require("../EmptyStateIndicator/EmptyStateIndicator.js"),S=require("../Toast/index.js");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function h(a){var v=this,p=a.tim,h=a.conversation,m=a.className,x=a.children,E=a.TUIMessage,U=a.TUIChatHeader,j=a.TUIMessageInput,f=a.InputPlugins,q=a.MessagePlugins,P=a.MessageContext,A=a.InputQuote,L=a.onMessageRecevied,H=a.sendMessage,N=a.revokeMessage,D=a.messageConfig,y=a.cloudCustomData,R=a.TUIMessageInputConfig,O=a.TUIMessageListConfig,w=s.useReducer(T.chatReducer,e.__assign(e.__assign({},T.initialState),{conversation:h})),Y=w[0],b=w[1],k=s.useRef(null),F=s.useRef(),G=o(e.__assign({tim:p,conversation:h,messageListRef:k,textareaRef:F,messageConfig:D,cloudCustomData:y,TUIMessageInputConfig:R,TUIMessageListConfig:O},Y)),Q=M.useCreateMessage({tim:p,conversation:h,cloudCustomData:y}),V=Q.createTextMessage,K=Q.createFaceMessage,X=Q.createImageMessage,z=Q.createVideoMessage,B=Q.createFileMessage,J=Q.createForwardMessage,W=Q.createCustomMessage,Z=Q.createAudioMessage,$=Q.createTextAtMessage,ee=Q.createLocationMessage,se=Q.createMergerMessage,te=d.useHandleMessageList({tim:p,conversation:h,state:Y,dispatch:b}),ae=te.getMessageList,re=te.updateMessage,ne=te.editLocalmessage,ie=te.removeMessage,oe=te.updataUploadPenddingMessageList,ue=I.useHandleMessage({state:Y,dispatch:b}),ge=ue.operateMessage,ce=ue.setAudioSource,Te=ue.setVideoSource,Me=ue.setHighlightedMessageId,de=function(s,t){return e.__awaiter(v,void 0,void 0,(function(){var a;return e.__generator(this,(function(e){switch(e.label){case 0:re([s]),e.label=1;case 1:return e.trys.push([1,6,,7]),H?[4,H(s,t)]:[3,3];case 2:return e.sent(),[3,5];case 3:return[4,p.sendMessage(s,t)];case 4:e.sent(),e.label=5;case 5:return ne(s),[3,7];case 6:throw a=e.sent(),S.Toast({text:a,type:"error"}),ne(s),new Error(a);case 7:return[2]}}))}))},Ie=function(){return e.__awaiter(v,void 0,void 0,(function(){var s;return e.__generator(this,(function(e){switch(e.label){case 0:return Y.isCompleted?(b({type:g.CONSTANT_DISPATCH_TYPE.SET_NO_MORE,value:!0}),[2]):[4,ae({nextReqMessageID:Y.nextReqMessageID})];case 1:return s=e.sent(),b({type:g.CONSTANT_DISPATCH_TYPE.SET_HISTORY_MESSAGELIST,value:s.data.messageList}),b({type:g.CONSTANT_DISPATCH_TYPE.SET_IS_COMPLETE,value:s.data.isCompleted}),b({type:g.CONSTANT_DISPATCH_TYPE.SET_NEXT_REQ_MESSAGE_ID,value:s.data.nextReqMessageID}),[2]}}))}))};c.useMessageReceviedListener(re,L),s.useEffect((function(){e.__awaiter(v,void 0,void 0,(function(){var s;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,ae()];case 1:return(s=e.sent()).data.messageList.length>0&&b({type:g.CONSTANT_DISPATCH_TYPE.SET_MESSAGELIST,value:s.data.messageList}),b({type:g.CONSTANT_DISPATCH_TYPE.SET_MESSAGELIST,value:s.data.messageList}),b({type:g.CONSTANT_DISPATCH_TYPE.SET_IS_COMPLETE,value:s.data.isCompleted}),b({type:g.CONSTANT_DISPATCH_TYPE.SET_NEXT_REQ_MESSAGE_ID,value:s.data.nextReqMessageID}),[2]}}))}))}),[h]);var le=s.useMemo((function(){return{sendMessage:de,removeMessage:ie,updateMessage:re,createTextMessage:V,createFaceMessage:K,createImageMessage:X,createVideoMessage:z,createFileMessage:B,createForwardMessage:J,createCustomMessage:W,createAudioMessage:Z,createTextAtMessage:$,createLocationMessage:ee,createMergerMessage:se,editLocalmessage:ne,operateMessage:ge,loadMore:Ie,revokeMessage:N,setAudioSource:ce,setVideoSource:Te,setHighlightedMessageId:Me,updataUploadPenddingMessageList:oe}}),[de,ie,re,V,K,X,z,B,J,W,Z,$,ee,se,ne,ge,Ie,N,ce,Te,Me,oe]),Ce=s.useMemo((function(){return{TUIMessage:E||u.TUIMessage,MessageContext:P,InputPlugins:f,MessagePlugins:q,TUIChatHeader:U,TUIMessageInput:j,InputQuote:A}}),[]);return t.jsx("div",e.__assign({className:"chat ".concat(m)},{children:t.jsx(r.TUIChatStateContextProvider,e.__assign({value:G},{children:t.jsx(n.TUIChatActionProvider,e.__assign({value:le},{children:t.jsx(i.ComponentProvider,e.__assign({value:Ce},{children:x||t.jsxs(t.Fragment,{children:[t.jsx(l.TUIChatHeader,{}),t.jsx(C.TUIMessageList,{}),t.jsx(_.TUIMessageInput,{})]})}))}))}))}))}var m=p(s).default.memo((function(r){var n=r.conversation,i=r.EmptyPlaceholder,o=void 0===i?t.jsx(v.EmptyStateIndicator,{listType:"chat"}):i,u=a.useTUIKitContext("TUIChat"),g=u.conversation,c=u.tim,T=n||g;return(null==T?void 0:T.conversationID)?s.createElement(h,e.__assign({tim:c},r,{conversation:T,key:T.conversationID})):o}));exports.TUIChat=m;
