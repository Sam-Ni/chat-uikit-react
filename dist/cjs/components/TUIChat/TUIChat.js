"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),s=require("react"),t=require("react/jsx-runtime"),a=require("../../context/TUIKitContext.js"),r=require("../../context/TUIChatStateContext.js"),n=require("../../context/TUIChatActionContext.js"),i=require("../../context/ComponentContext.js"),o=require("./hooks/useCreateTUIChatStateContext.js"),u=require("../TUIMessage/TUIMessage.js");require("../TUIMessage/MessagePlugins.js"),require("../TUIMessage/MessageContext.js");var g=require("../../constants.js"),c=require("./hooks/useMessageReceviedListener.js"),M=require("./TUIChatState.js"),d=require("./hooks/useCreateMessage.js"),T=require("./hooks/useHandleMessageList.js"),I=require("./hooks/useHandleMessage.js"),l=require("../TUIChatHeader/TUIChatHeader.js");require("tim-js-sdk"),require("../Icon/config.js"),require("../Icon/type.js"),require("date-fns"),require("../../context/TUIMessageContext.js");var _=require("../TUIMessageList/TUIMessageList.js"),C=require("../TUIMessageInput/TUIMessageInput.js"),S=require("../EmptyStateIndicator/EmptyStateIndicator.js"),v=require("../Toast/index.js");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function h(r){var n=r.conversation,i=r.EmptyPlaceholder,o=void 0===i?t.jsx(S.EmptyStateIndicator,{listType:"chat"}):i,u=a.useTUIKitContext("TUIChat"),g=u.conversation,c=u.tim,M=n||g;return(null==M?void 0:M.conversationID)?s.createElement(m,e.__assign({tim:c},r,{conversation:M,key:M.conversationID})):o}function m(a){var S=this,p=a.tim,h=a.conversation,m=a.className,E=a.children,x=a.TUIMessage,U=a.TUIChatHeader,j=a.TUIMessageInput,f=a.InputPlugins,q=a.MessagePlugins,P=a.MessageContext,A=a.InputQuote,L=a.onMessageRecevied,N=a.sendMessage,H=a.revokeMessage,y=a.messageConfig,D=a.cloudCustomData,R=a.TUIMessageInputConfig,O=a.TUIMessageListConfig,w=s.useReducer(M.chatReducer,e.__assign(e.__assign({},M.initialState),{conversation:h})),k=w[0],Y=w[1],b=s.useRef(null),F=s.useRef(),G=o(e.__assign({tim:p,conversation:h,messageListRef:b,textareaRef:F,messageConfig:y,cloudCustomData:D,TUIMessageInputConfig:R,TUIMessageListConfig:O},k)),Q=d.useCreateMessage({tim:p,conversation:h,cloudCustomData:D}),V=Q.createTextMessage,K=Q.createFaceMessage,X=Q.createImageMessage,z=Q.createVideoMessage,B=Q.createFileMessage,J=Q.createForwardMessage,W=Q.createCustomMessage,Z=Q.createAudioMessage,$=Q.createTextAtMessage,ee=Q.createLocationMessage,se=Q.createMergerMessage,te=T.useHandleMessageList({tim:p,conversation:h,state:k,dispatch:Y}),ae=te.getMessageList,re=te.updateMessage,ne=te.editLocalmessage,ie=te.removeMessage,oe=te.updataUploadPenddingMessageList,ue=I.useHandleMessage({state:k,dispatch:Y}),ge=ue.operateMessage,ce=ue.setAudioSource,Me=ue.setVideoSource,de=ue.setHighlightedMessageId,Te=function(s,t){return e.__awaiter(S,void 0,void 0,(function(){var a;return e.__generator(this,(function(e){switch(e.label){case 0:re([s]),e.label=1;case 1:return e.trys.push([1,6,,7]),N?[4,N(s,t)]:[3,3];case 2:return e.sent(),[3,5];case 3:return[4,p.sendMessage(s,t)];case 4:e.sent(),e.label=5;case 5:return ne(s),[3,7];case 6:throw a=e.sent(),v.Toast({text:a,type:"error"}),ne(s),new Error(a);case 7:return[2]}}))}))},Ie=function(){return e.__awaiter(S,void 0,void 0,(function(){var s;return e.__generator(this,(function(e){switch(e.label){case 0:return k.isCompleted?(Y({type:g.CONSTANT_DISPATCH_TYPE.SET_NO_MORE,value:!0}),[2]):[4,ae({nextReqMessageID:k.nextReqMessageID})];case 1:return s=e.sent(),Y({type:g.CONSTANT_DISPATCH_TYPE.SET_HISTORY_MESSAGELIST,value:s.data.messageList}),Y({type:g.CONSTANT_DISPATCH_TYPE.SET_IS_COMPLETE,value:s.data.isCompleted}),Y({type:g.CONSTANT_DISPATCH_TYPE.SET_NEXT_REQ_MESSAGE_ID,value:s.data.nextReqMessageID}),[2]}}))}))};c.useMessageReceviedListener(re,L),s.useEffect((function(){e.__awaiter(S,void 0,void 0,(function(){var s;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,ae()];case 1:return(s=e.sent()).data.messageList.length>0&&Y({type:g.CONSTANT_DISPATCH_TYPE.SET_MESSAGELIST,value:s.data.messageList}),Y({type:g.CONSTANT_DISPATCH_TYPE.SET_MESSAGELIST,value:s.data.messageList}),Y({type:g.CONSTANT_DISPATCH_TYPE.SET_IS_COMPLETE,value:s.data.isCompleted}),Y({type:g.CONSTANT_DISPATCH_TYPE.SET_NEXT_REQ_MESSAGE_ID,value:s.data.nextReqMessageID}),[2]}}))}))}),[h]);var le=s.useMemo((function(){return{sendMessage:Te,removeMessage:ie,updateMessage:re,createTextMessage:V,createFaceMessage:K,createImageMessage:X,createVideoMessage:z,createFileMessage:B,createForwardMessage:J,createCustomMessage:W,createAudioMessage:Z,createTextAtMessage:$,createLocationMessage:ee,createMergerMessage:se,editLocalmessage:ne,operateMessage:ge,loadMore:Ie,revokeMessage:H,setAudioSource:ce,setVideoSource:Me,setHighlightedMessageId:de,updataUploadPenddingMessageList:oe}}),[Te,ie,re,V,K,X,z,B,J,W,Z,$,ee,se,ne,ge,Ie,H,ce,Me,de,oe]),_e=s.useMemo((function(){return{TUIMessage:x||u.TUIMessage,MessageContext:P,InputPlugins:f,MessagePlugins:q,TUIChatHeader:U,TUIMessageInput:j,InputQuote:A}}),[]);return t.jsx("div",e.__assign({className:"chat ".concat(m)},{children:t.jsx(r.TUIChatStateContextProvider,e.__assign({value:G},{children:t.jsx(n.TUIChatActionProvider,e.__assign({value:le},{children:t.jsx(i.ComponentProvider,e.__assign({value:_e},{children:E||t.jsxs(t.Fragment,{children:[t.jsx(l.TUIChatHeader,{}),t.jsx(_.TUIMessageList,{}),t.jsx(C.TUIMessageInput,{})]})}))}))}))}))}var E=p(s).default.memo(h);exports.TUIChat=E;
